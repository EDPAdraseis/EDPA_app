<!--
EDPA app: why it doesn't save on GitHub/Vercel

Your current code initializes Firebase ONLY if __firebase_config exists:
  const cfg = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
  if (cfg.apiKey) { ... window.fb = ... }

__firebase_config and __app_id are injected automatically ONLY on Firebase Hosting.
On Vercel/GitHub Pages they are undefined, cfg becomes {}, window.fb never gets set,
so Firestore writes never happen.

Fix: hardcode (or env-inject) your Firebase web config and appId, then initialize.
Also ensure Firestore rules allow writes for authenticated (anonymous) users.

Below is your file with the MINIMUM necessary changes:
- Add firebaseConfig + APP_ID
- Always initialize Firebase (no __firebase_config dependency)

Replace the firebase <script type="module"> block with the one below.
-->

<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Î•Î¸ÎµÎ»Î¿Î½Ï„Î¹ÎºÎ® Î”ÏÎ¬ÏƒÎ· Î Î¬ÏÎ½Î·Î¸Î±Ï‚</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- âœ… REPLACE THIS ENTIRE MODULE SCRIPT WITH YOUR REAL FIREBASE CONFIG -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      signInAnonymously,
      signInWithCustomToken,
      onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      doc,
      deleteDoc,
      query,
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // 1) Put your Firebase web app config here (Firebase Console -> Project settings -> Your apps -> Web app)
    // IMPORTANT: this is safe to be public, security is enforced by Firestore Rules.
    const firebaseConfig = {
      apiKey: "PASTE_YOUR_API_KEY",
      authDomain: "PASTE_YOUR_AUTH_DOMAIN",
      projectId: "PASTE_YOUR_PROJECT_ID",
      storageBucket: "PASTE_YOUR_STORAGE_BUCKET",
      messagingSenderId: "PASTE_YOUR_SENDER_ID",
      appId: "PASTE_YOUR_APP_ID",
    };

    // 2) If you used Firebase Hosting before, __app_id was injected.
    // On Vercel/GitHub it is not. Use a stable string.
    window.APP_ID = "edpa-app";

    // 3) Initialize Firebase ALWAYS
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Optional: if you still want to support Firebase Hosting custom token injection
    const initialToken = (typeof window.__initial_auth_token !== "undefined" && window.__initial_auth_token)
      ? window.__initial_auth_token
      : null;

    // Expose helpers exactly like your existing code expects
    window.fb = {
      auth,
      db,
      signInAnonymously,
      signInWithCustomToken,
      onAuthStateChanged,
      collection,
      addDoc,
      onSnapshot,
      doc,
      deleteDoc,
      query,
      initialToken,
    };
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    html,body,#root{height:100%;margin:0;padding:0;overflow:hidden;background-color:#f8fafc;font-family:'Inter',sans-serif}
    #root{display:flex;flex-direction:column}
    .tab-content{width:100%;height:100%;display:flex;flex-direction:column;animation:f .3s ease-out}
    @keyframes f{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .btn-active:active{transform:scale(0.95)}
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const Icon = ({ n, s = 20 }) => {
      const m = {
        tree: 'ğŸŒ²',
        menu: 'â˜°',
        heart: 'â¤ï¸',
        news: 'ğŸ“°',
        trash: 'ğŸ—‘ï¸',
        map: 'ğŸ—ºï¸',
        calendar: 'ğŸ“…',
        settings: 'âš™ï¸',
        home: 'ğŸ ',
        mail: 'âœ‰ï¸',
        x: 'âœ–ï¸',
        pin: 'ğŸ“',
        phone: 'ğŸ“',
      };
      return (
        <span style={{ fontSize: s + 'px', lineHeight: '1' }} className="inline-flex items-center justify-center">
          {m[n] || 'â“'}
        </span>
      );
    };

    const App = () => {
      const [t, setT] = useState('home');
      const [m, setM] = useState(false);
      const [u, setU] = useState(null);
      const [actions, setActions] = useState([]);
      const [news, setNews] = useState([]);
      const [isAdmin, setIsAdmin] = useState(false);
      const [pass, setPass] = useState("");
      const [st, setSt] = useState(null);
      const [ld, setLd] = useState(false);
      const [fA, setFA] = useState({ t: '', d: '', l: '' });
      const [fN, setFN] = useState({ t: '', s: '' });
      const mr = useRef(null);

      // âœ… Use stable app id when not on Firebase Hosting
      const aid = (typeof window.__app_id !== 'undefined' && window.__app_id) ? window.__app_id : (window.APP_ID || 'edpa-app');

      const msg = (txt, tp = 'info') => {
        setSt({ txt, tp });
        setTimeout(() => setSt(null), 4000);
      };

      useEffect(() => {
        const checkFB = setInterval(() => {
          if (window.fb) {
            clearInterval(checkFB);

            const authInit = async () => {
              try {
                // If a custom token exists (Firebase Hosting), use it. Otherwise sign in anonymously.
                if (window.fb.initialToken) {
                  await window.fb.signInWithCustomToken(window.fb.auth, window.fb.initialToken);
                } else {
                  await window.fb.signInAnonymously(window.fb.auth);
                }

                window.fb.onAuthStateChanged(window.fb.auth, user => setU(user));
              } catch (e) {
                console.error(e);
                msg('Î£Ï†Î¬Î»Î¼Î± Auth', 'error');
              }
            };

            authInit();
          }
        }, 200);

        return () => clearInterval(checkFB);
      }, []);

      useEffect(() => {
        if (!u || !window.fb) return;
        const getC = (n) => window.fb.collection(window.fb.db, 'artifacts', aid, 'public', 'data', n);

        const u1 = window.fb.onSnapshot(
          getC('actions'),
          s => setActions(s.docs.map(d => ({ id: d.id, ...d.data() }))),
          e => console.error('Actions:', e)
        );

        const u2 = window.fb.onSnapshot(
          getC('news'),
          s => setNews(s.docs.map(d => ({ id: d.id, ...d.data() }))),
          e => console.error('News:', e)
        );

        return () => { u1(); u2(); };
      }, [u]);

      useEffect(() => {
        if (t === 'map') {
          const i = setTimeout(() => {
            const d = document.getElementById('map-display');
            if (!d) return;
            if (mr.current) mr.current.remove();

            const mp = L.map('map-display', { zoomControl: false }).setView([38.16, 23.74], 12);
            mr.current = mp;
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mp);

            const rs = () => mp.invalidateSize();
            const o = new ResizeObserver(rs);
            o.observe(d);
            setTimeout(rs, 300);
            return () => o.disconnect();
          }, 100);

          return () => clearTimeout(i);
        }
      }, [t]);

      const add = async (n, data) => {
        if (!u) {
          msg('ÎŒÏ‡Î¹ ÏƒÏÎ½Î´ÎµÏƒÎ·', 'error');
          return false;
        }
        setLd(true);
        try {
          const ref = window.fb.collection(window.fb.db, 'artifacts', aid, 'public', 'data', n);
          await window.fb.addDoc(ref, data);
          msg('Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ!', 'success');
          setLd(false);
          return true;
        } catch (e) {
          console.error(e);
          msg('Î£Ï†Î¬Î»Î¼Î±: ' + (e.message || '').slice(0, 40), 'error');
          setLd(false);
          return false;
        }
      };

      const del = async (n, id) => {
        try {
          await window.fb.deleteDoc(window.fb.doc(window.fb.db, 'artifacts', aid, 'public', 'data', n, id));
          msg('Î”Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ!');
        } catch (e) {
          msg('Î£Ï†Î¬Î»Î¼Î±', 'error');
        }
      };

      // The rest of your UI is unchanged...
      return (
        <div className="flex flex-col h-full w-full max-w-lg mx-auto bg-white relative overflow-hidden shadow-2xl">
          {/* ... keep your existing JSX exactly as-is ... */}
          <div className="p-6 text-xs text-slate-500">
            UI omitted here to keep the patch readable. Paste your existing JSX below this point.
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>

<!--
FIRESTORE RULES (IMPORTANT)

If you still can't save, it is usually Firestore Rules blocking writes.
For testing ONLY, you can temporarily use:

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /artifacts/{appId}/public/data/{col}/{docId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
  }
}

Then later tighten it (admin-only writes, etc.).
-->
